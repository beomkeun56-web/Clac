<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BK v3.5 Revised</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace'],
                    },
                    colors: {
                        dark: {
                            bg: '#0a0a0a',
                            card: '#171717',
                            border: '#262626'
                        }
                    }
                }
            }
        }
    </script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #525252; border-radius: 2px; }
        button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans selection:bg-blue-500 selection:text-white overflow-x-hidden transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useMemo, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { ChevronLeft, ChevronRight, Plus, Minus, X, Wallet, TrendingUp, TrendingDown, Calendar as CalendarIcon, Settings, Moon, Sun, List, LayoutGrid, Download, Upload, Pencil, BarChart3, Trash2, Scale, Table2, StickyNote } from 'lucide-react';

        const APP_VERSION = "v3.5 Rev";
        
        const FONT_SIZES = ['text-xs', 'text-sm', 'text-base', 'text-lg', 'text-xl', 'text-2xl', 'text-3xl', 'text-4xl'];
        const FONT_LABELS = ['80%', '90%', '100%', '110%', '120%', '130%', '140%', '150%'];
        
        const formatCurrency = (amount, currency) => {
            const options = { style: 'currency', currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 };
            return new Intl.NumberFormat(currency === 'KRW' ? 'ko-KR' : 'zh-CN', options).format(amount);
        };

        const formatCompactNumber = (number) => {
            if (number === 0) return '0';
            const abs = Math.abs(number);
            if (abs < 1000) return new Intl.NumberFormat('ko-KR').format(number);
            if (abs < 10000) {
                 const val = number / 1000;
                 return val.toFixed(val % 1 === 0 ? 0 : 1) + '천';
            }
            const val = number / 10000;
            return val.toFixed(val % 1 === 0 ? 0 : 1) + '만';
        };

        const generateCalendarDays = (year, month) => {
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDayOfMonth.getDay();
            const daysInMonth = lastDayOfMonth.getDate();
            const days = [];
            for (let i = 0; i < startDayOfWeek; i++) days.push({ day: null, dateStr: null });
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                days.push({ day: i, dateStr: dateStr });
            }
            return days;
        };

        const DEFAULT_CATEGORIES = {
            income: ['급여', '용돈', '상여금', '금융수입', '기타'],
            expense: ['식비', '교통', '문화', '공과금', '쇼핑', '주거', '의료', '기타']
        };
        const DEFAULT_MAIN_CATEGORIES = {
            income: ['근로소득', '금융소득', '기타'],
            expense: ['고정지출', '변동지출', '저축', '기타']
        };

        function App() {
            const [isLoaded, setIsLoaded] = useState(false);
            const [initialBalance, setInitialBalance] = useState(0);
            const [currency, setCurrency] = useState('KRW'); 
            const [isDarkMode, setIsDarkMode] = useState(true); 
            const [fontIndex, setFontIndex] = useState(2); 
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('calendar');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [transactions, setTransactions] = useState([]);
            const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
            const [mainCategories, setMainCategories] = useState(DEFAULT_MAIN_CATEGORIES);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [selectedDateDetail, setSelectedDateDetail] = useState(null); 
            const [settingsTab, setSettingsTab] = useState('general');
            const [newCategoryName, setNewCategoryName] = useState('');
            const [categoryTypeToAdd, setCategoryTypeToAdd] = useState('expense');
            const [newTrans, setNewTrans] = useState({
                date: new Date().toISOString().split('T')[0],
                type: 'expense',
                mainCategory: '', 
                category: '',
                amount: '',
                desc: '',
                memo: '' 
            });

            useEffect(() => {
                const savedData = localStorage.getItem('bk_budget_data_v21');
                const savedFontIndex = localStorage.getItem('bk_budget_font_idx');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.initialBalance !== undefined) setInitialBalance(parsed.initialBalance);
                        if (parsed.currency) setCurrency(parsed.currency);
                        if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
                        if (parsed.transactions) setTransactions(parsed.transactions);
                        if (parsed.categories) setCategories(parsed.categories);
                        if (parsed.mainCategories) setMainCategories(parsed.mainCategories);
                    } catch (e) { console.error(e); }
                }
                if (savedFontIndex !== null) {
                    const idx = parseInt(savedFontIndex, 10);
                    if (idx >= 0 && idx < FONT_SIZES.length) setFontIndex(idx);
                }
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (isLoaded) {
                    const dataToSave = { initialBalance, currency, isDarkMode, transactions, categories, mainCategories };
                    localStorage.setItem('bk_budget_data_v21', JSON.stringify(dataToSave)); 
                }
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                    document.body.classList.add('bg-dark-bg', 'text-gray-100');
                    document.body.classList.remove('bg-gray-50', 'text-gray-900');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.body.classList.remove('bg-dark-bg', 'text-gray-100');
                    document.body.classList.add('bg-gray-50', 'text-gray-900');
                }
            }, [initialBalance, currency, isDarkMode, transactions, categories, mainCategories, isLoaded]);

            const handleFontUp = () => { const newIndex = Math.min(fontIndex + 1, FONT_SIZES.length - 1); setFontIndex(newIndex); localStorage.setItem('bk_budget_font_idx', newIndex); };
            const handleFontDown = () => { const newIndex = Math.max(fontIndex - 1, 0); setFontIndex(newIndex); localStorage.setItem('bk_budget_font_idx', newIndex); };

            useEffect(() => {
                if (isModalOpen && !editingId) {
                    const currentMainCats = newTrans.type === 'income' ? mainCategories.income : mainCategories.expense;
                    const currentSubCats = newTrans.type === 'income' ? categories.income : categories.expense;
                    setNewTrans(prev => ({ 
                        ...prev, 
                        mainCategory: currentMainCats.length > 0 ? currentMainCats[0] : '',
                        category: currentSubCats.length > 0 ? currentSubCats[0] : ''
                    }));
                }
            }, [newTrans.type, categories, mainCategories, isModalOpen, editingId]);

            const handleExport = () => {
                const dataToSave = { initialBalance, currency, isDarkMode, transactions, categories, mainCategories, exportDate: new Date().toISOString(), version: APP_VERSION };
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `BK_Budget_${APP_VERSION}_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        if (window.confirm("데이터를 복원하시겠습니까?")) {
                            if (parsed.initialBalance !== undefined) setInitialBalance(parsed.initialBalance);
                            if (parsed.currency) setCurrency(parsed.currency);
                            if (parsed.isDarkMode !== undefined) setIsDarkMode(parsed.isDarkMode);
                            if (parsed.transactions) setTransactions(parsed.transactions);
                            if (parsed.categories) setCategories(parsed.categories);
                            if (parsed.mainCategories) setMainCategories(parsed.mainCategories);
                            alert("복원 완료");
                            setIsSettingsOpen(false);
                        }
                    } catch (err) { alert("파일 오류"); }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth(); 
            const sortedTransactions = useMemo(() => [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date)), [transactions]);

            const dailyStatsMap = useMemo(() => {
                const stats = {};
                let runningBalance = Number(initialBalance); 
                sortedTransactions.forEach(t => {
                    const dateKey = t.date;
                    if (!stats[dateKey]) stats[dateKey] = { income: 0, expense: 0, balance: 0 };
                    if (t.type === 'income') { stats[dateKey].income += Number(t.amount); runningBalance += Number(t.amount); }
                    else { stats[dateKey].expense += Number(t.amount); runningBalance -= Number(t.amount); }
                    stats[dateKey].balance = runningBalance;
                });
                return { stats, finalBalance: runningBalance };
            }, [sortedTransactions, initialBalance]);

            const allTimeStats = useMemo(() => {
                let income = 0;
                let expense = 0;
                transactions.forEach(t => {
                    if (t.type === 'income') income += Number(t.amount);
                    else expense += Number(t.amount);
                });
                const balance = Number(initialBalance) + income - expense;
                return { income, expense, balance };
            }, [transactions, initialBalance]);

            const categoryStats = useMemo(() => {
                const startStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endStr = `${year}-${String(month + 1).padStart(2, '0')}-31`;
                let carryover = Number(initialBalance);
                transactions.forEach(t => {
                    if (t.date < startStr) {
                        if (t.type === 'income') carryover += Number(t.amount);
                        else carryover -= Number(t.amount);
                    }
                });
                
                const currentMonthTrans = transactions.filter(t => t.date >= startStr && t.date <= endStr);
                const monthlyIncome = currentMonthTrans.filter(t => t.type === 'income').reduce((a, b) => a + Number(b.amount), 0);
                const monthlyExpense = currentMonthTrans.filter(t => t.type === 'expense').reduce((a, b) => a + Number(b.amount), 0);
                const totalRevenue = carryover + monthlyIncome;
                const finalBalance = totalRevenue - monthlyExpense;

                // Simple hierarchy for stats
                const hierarchy = { income: {}, expense: {} };
                currentMonthTrans.forEach(t => {
                    const type = t.type;
                    const mainCat = t.mainCategory || '기타';
                    const subCat = t.category || '기타';
                    const amt = Number(t.amount);
                    
                    if(!hierarchy[type][mainCat]) hierarchy[type][mainCat] = { total: 0, subs: {} };
                    hierarchy[type][mainCat].total += amt;
                    
                    if(!hierarchy[type][mainCat].subs[subCat]) hierarchy[type][mainCat].subs[subCat] = { total: 0 };
                    hierarchy[type][mainCat].subs[subCat].total += amt;
                });

                const sortHierarchy = (data) => Object.entries(data).map(([key, val]) => ({
                    name: key, ...val, subs: Object.entries(val.subs).map(([sKey, sVal]) => ({ name: sKey, ...sVal })).sort((a,b) => b.total - a.total)
                })).sort((a,b) => b.total - a.total);

                return { 
                    income: sortHierarchy(hierarchy.income), 
                    expense: sortHierarchy(hierarchy.expense),
                    monthlyIncome, monthlyExpense, carryover, totalRevenue, finalBalance 
                };
            }, [transactions, year, month, initialBalance]);

            const getBalanceAtDate = (targetDateStr) => {
                let balance = Number(initialBalance); 
                for (const t of sortedTransactions) {
                    if (t.date > targetDateStr) break;
                    if (t.type === 'income') balance += Number(t.amount);
                    else balance -= Number(t.amount);
                }
                return balance;
            };

            const handlePrevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
            const handleNextMonth = () => setCurrentDate(new Date(year, month + 1, 1));

            const handleSaveTransaction = (e) => {
                e.preventDefault();
                if (!newTrans.amount || !newTrans.desc) return;
                const currentMainCats = newTrans.type === 'income' ? mainCategories.income : mainCategories.expense;
                const currentSubCats = newTrans.type === 'income' ? categories.income : categories.expense;
                const transToSave = { 
                    ...newTrans, 
                    mainCategory: newTrans.mainCategory || (currentMainCats[0] || '기타'),
                    category: newTrans.category || (currentSubCats[0] || '기타'),
                    amount: Number(newTrans.amount) 
                };
                if (editingId) setTransactions(prev => prev.map(t => t.id === editingId ? { ...transToSave, id: editingId } : t));
                else setTransactions([...transactions, { id: Date.now(), ...transToSave }]);
                setIsModalOpen(false); setEditingId(null); setNewTrans({ ...newTrans, amount: '', desc: '', category: '', mainCategory: '', memo: '' }); setSelectedDateDetail(null);
            };

            const handleEditClick = (transaction) => {
                setEditingId(transaction.id);
                setNewTrans({ date: transaction.date, type: transaction.type, amount: transaction.amount, desc: transaction.desc, category: transaction.category || '', mainCategory: transaction.mainCategory || '', memo: transaction.memo || '' });
                setIsModalOpen(true); setSelectedDateDetail(null);
            };

            const handleDelete = (id) => {
                if (window.confirm("삭제하시겠습니까?")) {
                    setTransactions(transactions.filter(t => t.id !== id));
                    if (selectedDateDetail) setSelectedDateDetail(prev => ({ ...prev, items: prev.items.filter(i => i.id !== id) }));
                }
            };

            const handleDateClick = (dateStr) => {
                if (!dateStr) return;
                const dayTrans = transactions.filter(t => t.date === dateStr);
                setSelectedDateDetail({ dateStr, items: dayTrans });
            };

            const handleAddCategory = (isMain) => {
                if (!newCategoryName.trim()) return;
                const type = categoryTypeToAdd;
                const targetState = isMain ? mainCategories : categories;
                const setTargetState = isMain ? setMainCategories : setCategories;
                if (targetState[type].includes(newCategoryName)) return;
                setTargetState(prev => ({ ...prev, [type]: [...prev[type], newCategoryName] }));
                setNewCategoryName('');
            };

            const handleDeleteCategory = (isMain, type, name) => {
                const targetState = isMain ? mainCategories : categories;
                const setTargetState = isMain ? setMainCategories : setCategories;
                if (targetState[type].length <= 1) return;
                if (window.confirm(`삭제?`)) {
                    setTargetState(prev => ({ ...prev, [type]: prev[type].filter(c => c !== name) }));
                }
            };

            const calendarDays = generateCalendarDays(year, month);
            
            // Themes
            const theme = {
                bg: isDarkMode ? 'bg-dark-bg' : 'bg-gray-50',
                text: isDarkMode ? 'text-gray-100' : 'text-gray-900',
                card: isDarkMode ? 'bg-dark-card border-dark-border' : 'bg-white border-gray-100',
                cardText: isDarkMode ? 'text-gray-200' : 'text-gray-900',
                subText: isDarkMode ? 'text-gray-400' : 'text-gray-500',
                border: isDarkMode ? 'border-dark-border' : 'border-gray-200',
                input: isDarkMode ? 'bg-[#262626] border-neutral-700 text-white' : 'bg-white border-gray-200 text-gray-900',
                accent: 'bg-blue-600 text-white',
            };

            const currentFontSizeClass = FONT_SIZES[fontIndex];

            // Render
            if (!isLoaded) return null; 

            return (
                <div className={`min-h-screen font-sans ${theme.bg} ${theme.text} ${currentFontSizeClass} pb-20`}>
                    {/* Header */}
                    <header className={`sticky top-0 z-40 border-b ${theme.border} ${isDarkMode ? 'bg-dark-bg/80' : 'bg-white/80'} backdrop-blur-md`}>
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-blue-600 p-2 rounded-xl text-white shadow-lg shadow-blue-500/30"><CalendarIcon size={20} /></div>
                                <div><h1 className={`font-bold leading-none ${theme.cardText}`}>BK Budget</h1><span className="text-[10px] text-blue-500">{APP_VERSION}</span></div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 text-gray-400">{isDarkMode ? <Sun size={20} /> : <Moon size={20} />}</button>
                                <button onClick={() => { setIsSettingsOpen(true); setSettingsTab('general'); }} className="p-2 text-gray-400"><Settings size={20} /></button>
                                <button onClick={() => { setEditingId(null); setIsModalOpen(true); }} className={`ml-2 px-3 py-2 rounded-lg text-sm font-medium ${theme.accent}`}><Plus size={16} /> <span className="hidden sm:inline">추가</span></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-6">
                        {/* Dashboard */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className={`rounded-2xl p-6 border ${theme.border} ${theme.card}`}>
                                <div className="text-sm text-gray-500 mb-1">최종 잔액</div>
                                <div className={`text-3xl font-bold ${categoryStats.finalBalance >= 0 ? 'text-blue-500' : 'text-rose-500'}`}>{formatCurrency(categoryStats.finalBalance, currency)}</div>
                            </div>
                            <div className={`rounded-2xl p-6 border ${theme.border} ${theme.card}`}>
                                <div className="text-sm text-gray-500 mb-1">이번 달 수입</div>
                                <div className="text-2xl font-bold text-blue-500">+{formatCompactNumber(categoryStats.monthlyIncome)}</div>
                            </div>
                            <div className={`rounded-2xl p-6 border ${theme.border} ${theme.card}`}>
                                <div className="text-sm text-gray-500 mb-1">이번 달 지출</div>
                                <div className="text-2xl font-bold text-rose-500">-{formatCompactNumber(categoryStats.monthlyExpense)}</div>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex gap-2 mb-6 overflow-x-auto">
                            {['calendar', 'list', 'stats'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 rounded-lg text-sm font-bold capitalize ${activeTab === tab ? 'bg-blue-600 text-white' : 'text-gray-500 bg-gray-100 dark:bg-neutral-800'}`}>{tab}</button>
                            ))}
                        </div>

                        {/* Calendar View (Redesigned) */}
                        {activeTab === 'calendar' && (
                            <div className={`rounded-2xl border overflow-hidden ${theme.border} ${theme.card}`}>
                                <div className="flex justify-between items-center p-4 border-b border-gray-100 dark:border-neutral-800">
                                    <h2 className={`text-xl font-bold ${theme.cardText}`}>{year}년 {month + 1}월</h2>
                                    <div className="flex gap-1">
                                        <button onClick={handlePrevMonth} className="p-2 text-gray-500"><ChevronLeft size={20}/></button>
                                        <button onClick={handleNextMonth} className="p-2 text-gray-500"><ChevronRight size={20}/></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-7 border-b border-gray-100 dark:border-neutral-800 bg-gray-50 dark:bg-neutral-900">
                                    {['일', '월', '화', '수', '목', '금', '토'].map((day, idx) => (
                                        <div key={day} className={`py-2 text-center text-xs font-bold ${idx===0?'text-rose-500':idx===6?'text-blue-500':'text-gray-500'}`}>{day}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 auto-rows-fr bg-gray-200 dark:bg-neutral-800 gap-[1px]">
                                    {calendarDays.map((item, idx) => {
                                        if (!item.day) return <div key={`empty-${idx}`} className={`${theme.bg} min-h-[120px]`}></div>;
                                        
                                        const dateStats = dailyStatsMap.stats[item.dateStr];
                                        const currentBalance = dateStats ? dateStats.balance : getBalanceAtDate(item.dateStr);
                                        // Revenue (Prev Balance + Income)
                                        // Prev Balance = Current Balance - Income + Expense
                                        // Revenue = (Current Balance - Income + Expense) + Income = Current Balance + Expense
                                        // Or simply: Revenue = Funds available before spending
                                        const revenue = currentBalance + (dateStats?.expense || 0);

                                        const dayTransactions = transactions.filter(t => t.date === item.dateStr);
                                        const isToday = item.dateStr === new Date().toISOString().split('T')[0];

                                        return (
                                            <div key={item.dateStr} onClick={() => handleDateClick(item.dateStr)} className={`${theme.bg} min-h-[120px] p-1.5 relative cursor-pointer hover:bg-gray-50 dark:hover:bg-neutral-800/80 transition-colors flex flex-col gap-1`}>
                                                {isToday && <div className="absolute inset-0 border-2 border-blue-500/50 pointer-events-none"></div>}
                                                
                                                {/* Header: Day and Horizontal Stats */}
                                                <div className="flex flex-col gap-1">
                                                    <div className="flex justify-between items-start">
                                                        <span className={`text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full ${isToday ? 'bg-blue-600 text-white' : idx%7===0?'text-rose-500':idx%7===6?'text-blue-500':theme.subText}`}>{item.day}</span>
                                                        
                                                        {/* Horizontal Stats: [Income] [Revenue] [Expense] */}
                                                        <div className="flex gap-1.5 text-[9px] font-bold">
                                                            {dateStats?.income > 0 && <span className="text-blue-500">+{formatCompactNumber(dateStats.income)}</span>}
                                                            {(dateStats?.income > 0 || dateStats?.expense > 0) && <span className="text-gray-900 dark:text-white">{formatCompactNumber(revenue)}</span>}
                                                            {dateStats?.expense > 0 && <span className="text-rose-500">-{formatCompactNumber(dateStats.expense)}</span>}
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Transaction List (Pill Style) */}
                                                <div className="flex-1 flex flex-col gap-1 mt-1 overflow-hidden">
                                                    {dayTransactions.slice(0, 3).map((t) => (
                                                        <div key={t.id} className="flex items-center justify-between text-[9px] bg-gray-100 dark:bg-neutral-800/80 rounded px-1 py-0.5">
                                                            <div className="flex items-center gap-1 min-w-0 overflow-hidden">
                                                                <span className={`shrink-0 px-1 rounded-[3px] border ${t.type === 'income' ? 'border-blue-500/50 text-blue-500' : 'border-rose-500/50 text-rose-500'}`}>{t.category}</span>
                                                                <span className="truncate text-gray-700 dark:text-gray-300">{t.desc}</span>
                                                            </div>
                                                            <span className={`shrink-0 ml-1 ${t.type === 'income' ? 'text-blue-500' : 'text-rose-500'}`}>{formatCompactNumber(t.amount)}</span>
                                                        </div>
                                                    ))}
                                                    {dayTransactions.length > 3 && <div className="text-[8px] text-center text-gray-400">+{dayTransactions.length - 3} more</div>}
                                                </div>

                                                {/* Final Balance (Bottom, White/Default) */}
                                                <div className={`text-[10px] text-right font-bold mt-auto ${currentBalance < 0 ? 'text-rose-500' : 'text-gray-900 dark:text-white'}`}>
                                                    {formatCompactNumber(currentBalance)}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                        
                        {/* Other Views (Simplified for brevity as Calendar was the focus) */}
                        {activeTab === 'list' && (
                            <div className={`rounded-2xl border p-4 ${theme.border} ${theme.card}`}>
                                {transactions.filter(t => t.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`)).sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => (
                                    <div key={t.id} className="flex justify-between items-center p-3 border-b border-gray-100 dark:border-neutral-800 last:border-0">
                                        <div className="flex items-center gap-3">
                                            <div className={`p-2 rounded-full ${t.type === 'income' ? 'bg-blue-500/10 text-blue-500' : 'bg-rose-500/10 text-rose-500'}`}>{t.type==='income'?<TrendingUp size={16}/>:<TrendingDown size={16}/>}</div>
                                            <div>
                                                <div className="text-xs text-gray-500">{t.date} • {t.category}</div>
                                                <div className={`font-medium ${theme.cardText}`}>{t.desc}</div>
                                            </div>
                                        </div>
                                        <div className={`font-bold ${t.type==='income'?'text-blue-500':'text-rose-500'}`}>{t.type==='income'?'+':'-'}{formatCurrency(t.amount, currency)}</div>
                                    </div>
                                ))}
                                {transactions.length === 0 && <div className="text-center py-8 text-gray-500">내역 없음</div>}
                            </div>
                        )}
                        {activeTab === 'stats' && (
                             <div className={`rounded-2xl border p-6 ${theme.border} ${theme.card}`}>
                                 <h3 className={`font-bold mb-4 ${theme.cardText}`}>월간 요약</h3>
                                 <div className="space-y-4">
                                     {categoryStats.expense.map(cat => (
                                         <div key={cat.name}>
                                             <div className="flex justify-between text-sm mb-1"><span className={theme.subText}>{cat.name}</span><span className={theme.cardText}>{formatCurrency(cat.total, currency)}</span></div>
                                             <div className="w-full bg-gray-100 dark:bg-neutral-800 rounded-full h-2"><div className="bg-rose-500 h-2 rounded-full" style={{width: `${(cat.total/categoryStats.monthlyExpense)*100}%`}}></div></div>
                                         </div>
                                     ))}
                                 </div>
                             </div>
                        )}
                    </main>

                    {/* Modals */}
                    {selectedDateDetail && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setSelectedDateDetail(null)}></div>
                            <div className={`relative w-full max-w-sm rounded-2xl p-4 max-h-[80vh] overflow-y-auto ${theme.card}`}>
                                <h3 className={`font-bold text-lg mb-4 ${theme.cardText}`}>{selectedDateDetail.dateStr}</h3>
                                <div className="space-y-2 mb-4">
                                    {selectedDateDetail.items.map(t => (
                                        <div key={t.id} className={`flex justify-between items-center p-3 rounded-lg border ${theme.border} ${theme.bg}`}>
                                            <div>
                                                <span className={`text-[10px] px-1 rounded border mr-2 ${t.type==='income'?'border-blue-500 text-blue-500':'border-rose-500 text-rose-500'}`}>{t.category}</span>
                                                <span className={`text-sm ${theme.cardText}`}>{t.desc}</span>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className={`font-bold ${t.type==='income'?'text-blue-500':'text-rose-500'}`}>{formatCompactNumber(t.amount)}</span>
                                                <button onClick={() => handleDelete(t.id)}><Trash2 size={14} className="text-gray-400"/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => { setEditingId(null); setIsModalOpen(true); setNewTrans(prev => ({...prev, date: selectedDateDetail.dateStr})); setSelectedDateDetail(null); }} className={`w-full py-3 rounded-xl font-bold ${theme.accent}`}>추가하기</button>
                            </div>
                        </div>
                    )}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setIsModalOpen(false)}></div>
                            <div className={`relative w-full max-w-sm rounded-2xl p-6 ${theme.card}`}>
                                <h3 className={`font-bold text-lg mb-4 ${theme.cardText}`}>{editingId?'수정':'추가'}</h3>
                                <form onSubmit={handleSaveTransaction} className="space-y-4">
                                    <div className="flex bg-gray-100 dark:bg-neutral-800 p-1 rounded-lg">
                                        <button type="button" onClick={() => setNewTrans({...newTrans, type: 'income'})} className={`flex-1 py-2 rounded-md font-bold text-sm ${newTrans.type==='income'?'bg-white dark:bg-neutral-700 text-blue-600 shadow-sm':'text-gray-400'}`}>수입</button>
                                        <button type="button" onClick={() => setNewTrans({...newTrans, type: 'expense'})} className={`flex-1 py-2 rounded-md font-bold text-sm ${newTrans.type==='expense'?'bg-white dark:bg-neutral-700 text-rose-600 shadow-sm':'text-gray-400'}`}>지출</button>
                                    </div>
                                    <input type="date" value={newTrans.date} onChange={e=>setNewTrans({...newTrans, date: e.target.value})} className={`w-full p-3 rounded-lg border outline-none ${theme.input} ${theme.border}`}/>
                                    <input type="number" placeholder="금액" value={newTrans.amount} onChange={e=>setNewTrans({...newTrans, amount: e.target.value})} className={`w-full p-3 rounded-lg border outline-none ${theme.input} ${theme.border}`}/>
                                    <div className="flex gap-2">
                                        <select value={newTrans.mainCategory} onChange={e=>setNewTrans({...newTrans, mainCategory: e.target.value})} className={`flex-1 p-3 rounded-lg border outline-none ${theme.input} ${theme.border}`}>
                                            {(newTrans.type==='income'?mainCategories.income:mainCategories.expense).map(c=><option key={c} value={c}>{c}</option>)}
                                        </select>
                                        <select value={newTrans.category} onChange={e=>setNewTrans({...newTrans, category: e.target.value})} className={`flex-1 p-3 rounded-lg border outline-none ${theme.input} ${theme.border}`}>
                                            {(newTrans.type==='income'?categories.income:categories.expense).map(c=><option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <input type="text" placeholder="내용" value={newTrans.desc} onChange={e=>setNewTrans({...newTrans, desc: e.target.value})} className={`w-full p-3 rounded-lg border outline-none ${theme.input} ${theme.border}`}/>
                                    <button type="submit" className={`w-full py-3 rounded-xl font-bold ${theme.accent}`}>저장</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
